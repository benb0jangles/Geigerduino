<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ò¢ Radiation Monitor - Lancashire UK</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FFD700;
            --primary-dim: #B8960C;
            --secondary: #FFA500;
            --danger: #FF4444;
            --elevated: #FF8C00;
            --normal: #4CAF50;
            --bg: #0d0d0d;
            --bg-card: #161616;
            --bg-card2: #1e1e1e;
            --text: #E8E8E8;
            --text-dim: #888;
            --border: rgba(255, 215, 0, 0.2);
            --shadow: 0 4px 20px rgba(255, 215, 0, 0.08);
            --shadow-hover: 0 6px 28px rgba(255, 215, 0, 0.18);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Subtle scanline texture */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255,215,0,0.008) 2px,
                rgba(255,215,0,0.008) 4px
            );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header {
            text-align: center;
            padding: 44px 20px;
            background: linear-gradient(135deg, #111 0%, #1a1500 50%, #111 100%);
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 0 40px rgba(255,215,0,0.06), var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "‚ò¢";
            position: absolute;
            top: -10px; left: 10px;
            font-size: 8em;
            opacity: 0.04;
            line-height: 1;
        }

        header::after {
            content: "‚ò¢";
            position: absolute;
            bottom: -10px; right: 10px;
            font-size: 8em;
            opacity: 0.04;
            line-height: 1;
        }

        .header-icon {
            font-size: 3.5em;
            display: block;
            margin-bottom: 12px;
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255,215,0,0.4)); }
            50% { filter: drop-shadow(0 0 20px rgba(255,215,0,0.8)); }
        }

        header h1 {
            font-size: 2.2em;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(255,215,0,0.4);
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        header .subtitle {
            font-size: 1em;
            color: var(--text-dim);
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        header .location-tag {
            display: inline-block;
            margin-top: 12px;
            padding: 4px 14px;
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            font-size: 0.8em;
            color: var(--primary-dim);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
            padding: 18px 24px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .time-range-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .range-btn {
            padding: 9px 20px;
            border: 1px solid rgba(255,215,0,0.4);
            background: transparent;
            color: var(--primary-dim);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        .range-btn:hover {
            background: rgba(255,215,0,0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        .range-btn.active {
            background: rgba(255,215,0,0.15);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 12px rgba(255,215,0,0.2);
        }

        .controls-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        #lastUpdate {
            color: var(--text-dim);
            font-size: 0.85em;
        }

        .refresh-btn {
            padding: 9px 18px;
            background: rgba(255,215,0,0.1);
            color: var(--primary);
            border: 1px solid rgba(255,215,0,0.4);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,215,0,0.2);
            transform: rotate(180deg);
        }

        /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--primary-dim), var(--primary), var(--secondary));
        }

        .stat-card:hover {
            border-color: rgba(255,215,0,0.4);
            box-shadow: var(--shadow-hover);
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2.4em;
            margin-bottom: 8px;
            display: block;
        }

        .stat-label {
            font-size: 0.78em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2.4em;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 16px rgba(255,215,0,0.3);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-unit {
            font-size: 0.8em;
            color: var(--text-dim);
        }

        /* Status card specific */
        .stat-card.status-normal .stat-value  { color: var(--normal); text-shadow: 0 0 16px rgba(76,175,80,0.3); }
        .stat-card.status-elevated .stat-value { color: var(--elevated); text-shadow: 0 0 16px rgba(255,140,0,0.3); }
        .stat-card.status-high .stat-value    { color: var(--danger); text-shadow: 0 0 16px rgba(255,68,68,0.3); }
        .stat-card.status-danger .stat-value  {
            color: var(--danger);
            animation: blink-danger 0.8s step-end infinite;
        }
        @keyframes blink-danger {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ‚îÄ‚îÄ MIN / MAX SPLIT CARD ‚îÄ‚îÄ */
        .stat-minmax-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .stat-minmax-col { text-align: center; }

        .stat-minmax-val {
            font-size: 1.55em;
            font-weight: 700;
            line-height: 1;
            text-shadow: 0 0 12px currentColor;
        }

        .stat-minmax-lbl {
            font-size: 0.7em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .stat-minmax-divider {
            width: 1px;
            height: 36px;
            background: var(--border);
        }

        /* ‚îÄ‚îÄ RADIATION SCALE ‚îÄ‚îÄ */
        .scale-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .scale-title {
            font-size: 0.78em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 14px;
        }

        .scale-bar-wrap {
            position: relative;
        }

        .scale-bar {
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(90deg,
                #4CAF50 0%,
                #4CAF50 20%,
                #FFD700 20%,
                #FFA500 40%,
                #FF8C00 40%,
                #FF6600 60%,
                #FF4444 60%,
                #CC0000 80%,
                #880000 80%,
                #550000 100%
            );
            margin-bottom: 8px;
            position: relative;
        }

        .scale-marker {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 20px;
            background: white;
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
            transition: left 0.5s ease;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.72em;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .scale-zones {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .zone-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78em;
            color: var(--text-dim);
        }

        .zone-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
        }

        /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(460px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: border-color 0.3s;
        }

        .chart-container:hover {
            border-color: rgba(255,215,0,0.35);
        }

        .chart-container h3 {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .chart-container h3 span {
            color: var(--primary);
        }

        /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
        footer {
            text-align: center;
            padding: 28px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 0.82em;
            color: var(--text-dim);
        }

        footer p { margin: 6px 0; }

        footer a {
            color: var(--primary-dim);
            text-decoration: none;
        }

        footer a:hover { color: var(--primary); }

        /* ‚îÄ‚îÄ ERROR / LOADING ‚îÄ‚îÄ */
        .data-error {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            header h1 { font-size: 1.6em; }
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .controls { flex-direction: column; align-items: stretch; }
            .controls-right { justify-content: space-between; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
<div class="container">

    <header>
        <span class="header-icon">‚ò¢</span>
        <h1>Radiation Monitor</h1>
        <p class="subtitle">Real-time monitoring with ESP32-C3 &amp; SBM-20 Geiger Tube</p>
        <span class="location-tag">üìç Lancashire, United Kingdom</span>
    </header>

    <div class="controls">
        <div class="time-range-selector">
            <button class="range-btn active" data-range="1h">1 Hour</button>
            <button class="range-btn" data-range="24h">24 Hours</button>
            <button class="range-btn" data-range="7d">7 Days</button>
            <button class="range-btn" data-range="30d">30 Days</button>
        </div>
        <div class="controls-right">
            <span id="lastUpdate">Loading data...</span>
            <button class="refresh-btn" id="refreshBtn">‚Üª Refresh</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-icon">‚ö°</span>
            <div class="stat-label">Count Rate</div>
            <div class="stat-value" id="currentCPM">--</div>
            <div class="stat-unit">CPM</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">‚ò¢</span>
            <div class="stat-label">Dose Rate</div>
            <div class="stat-value" id="currentUSV">--</div>
            <div class="stat-unit">¬µSv/h</div>
        </div>
        <div class="stat-card" id="statusCard">
            <span class="stat-icon" id="statusIcon">üü¢</span>
            <div class="stat-label">Radiation Level</div>
            <div class="stat-value" id="currentStatus">--</div>
            <div class="stat-unit" id="statusDesc">Awaiting data</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üìä</span>
            <div class="stat-label">Data Points</div>
            <div class="stat-value" id="dataPoints">--</div>
            <div class="stat-unit">in selected range</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üìà</span>
            <div class="stat-label" id="avgUSVLabel">Period Average</div>
            <div class="stat-value" id="avgUSV">--</div>
            <div class="stat-unit">¬µSv/h</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">‚Üï</span>
            <div class="stat-label" id="minMaxLabel">Period Range</div>
            <div class="stat-minmax-row">
                <div class="stat-minmax-col">
                    <div class="stat-minmax-val" id="periodLow" style="color:#4CAF50">--</div>
                    <div class="stat-minmax-lbl">‚ñº Low</div>
                </div>
                <div class="stat-minmax-divider"></div>
                <div class="stat-minmax-col">
                    <div class="stat-minmax-val" id="periodHigh" style="color:#888">--</div>
                    <div class="stat-minmax-lbl">‚ñ≤ High</div>
                </div>
            </div>
            <div class="stat-unit">¬µSv/h</div>
        </div>
    </div>

    <div class="scale-container">
        <div class="scale-title">‚ò¢ Radiation Dose Scale ‚Äî Current Level Indicator</div>
        <div class="scale-bar-wrap">
            <div class="scale-bar">
                <div class="scale-marker" id="scaleMarker" style="left:5%"></div>
            </div>
        </div>
        <div class="scale-labels">
            <span>0</span>
            <span>0.3</span>
            <span>1.0</span>
            <span>5.0</span>
            <span>20</span>
            <span>100+ ¬µSv/h</span>
        </div>
        <div class="scale-zones">
            <span class="zone-label"><span class="zone-dot" style="background:#4CAF50"></span>Normal &lt;0.3 ¬µSv/h</span>
            <span class="zone-label"><span class="zone-dot" style="background:#FFD700"></span>Slightly Elevated 0.3‚Äì1.0</span>
            <span class="zone-label"><span class="zone-dot" style="background:#FF8C00"></span>Elevated 1.0‚Äì5.0</span>
            <span class="zone-label"><span class="zone-dot" style="background:#FF4444"></span>High 5.0‚Äì20.0</span>
            <span class="zone-label"><span class="zone-dot" style="background:#880000"></span>Danger &gt;20.0</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>‚ö° <span>Count Rate</span> ‚Äî CPM</h3>
            <canvas id="cpmChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>‚ò¢ <span>Dose Rate</span> ‚Äî ¬µSv/h</h3>
            <canvas id="usvChart"></canvas>
        </div>
    </div>

    <footer>
        <p>‚ò¢ Data sourced from <strong style="color:#b8960c">ioT Server</strong> ¬∑ Updated every 30 seconds</p>
        <p>Hardware: ESP32-C3 + SBM-20 Geiger-M√ºller Tube ¬∑ Conversion factor: 0.0057 ¬µSv/h per CPM</p>
        <p>Natural background radiation (global average) ‚âà 0.10‚Äì0.30 ¬µSv/h</p>
        <p style="margin-top:10px"><a href="https://github.com/benb0jangles/Geigerduino" target="_blank">GitHub: Geigerduino</a></p>
    </footer>

</div>

<script>
    // ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const CHANNEL_ID  = '2872097';
    const READ_API_KEY = 'OYQGPL9J3OTYU2P3';
    // field1 = CPM, field2 = ¬µSv/h, field3 = cumulative counts
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    let currentRange = '1h';
    let charts = {};
    let countdownTimer = null;

    const timeRanges = {
        // minutes=60   ‚Üí true 60-min window (results=120 was count-based;
        //                 gaps in data could make "1 Hour" show several hours)
        // days=1       ‚Üí 2,880 pts at 30s intervals, well under 8,000 cap ‚úì
        // days=7&average=60   ‚Üí hourly averages = 168 pts (days=7 alone = 20,160
        //                        pts, over ThingSpeak's 8,000 cap ‚Üí only ~2.7 days shown)
        // days=30&average=1440 ‚Üí daily averages = 30 pts (avoids cap entirely)
        '1h':  { param: 'minutes=60',              label: '1 Hour' },
        '24h': { param: 'days=1',                  label: '24 Hours' },
        '7d':  { param: 'days=7&average=60',        label: '7 Days' },
        '30d': { param: 'days=30&average=1440',     label: '30 Days' }
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentRange = e.target.dataset.range;
                loadData();
            });
        });
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        loadData();
    });

    async function loadData() {
        clearInterval(countdownTimer);
        document.getElementById('refreshBtn').textContent = '‚Üª Loading‚Ä¶';
        document.getElementById('lastUpdate').textContent = 'Loading...';
        const { param } = timeRanges[currentRange];
        const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&${param}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (!data.feeds || data.feeds.length === 0) throw new Error('No data');
            processData(data.feeds);
        } catch (err) {
            document.getElementById('lastUpdate').textContent = 'Error loading data';
            console.error(err);
        }
        startCountdown();
    }

    function startCountdown() {
        let secs = 30;
        const btn = document.getElementById('refreshBtn');
        btn.textContent = `‚Üª ${secs}s`;
        countdownTimer = setInterval(() => {
            secs--;
            if (secs <= 0) {
                clearInterval(countdownTimer);
                loadData();
            } else {
                btn.textContent = `‚Üª ${secs}s`;
            }
        }, 1000);
    }

    function processData(feeds) {
        const latest = feeds[feeds.length - 1];

        // Stat cards
        const cpm = parseFloat(latest.field1);
        const usv = parseFloat(latest.field2);

        document.getElementById('currentCPM').textContent = isNaN(cpm) ? '--' : cpm.toFixed(1);
        document.getElementById('currentUSV').textContent = isNaN(usv) ? '--' : usv.toFixed(4);
        document.getElementById('dataPoints').textContent = feeds.length;

        // Radiation status
        if (!isNaN(usv)) updateStatus(usv);

        // Scale marker
        if (!isNaN(usv)) updateScaleMarker(usv);

        // Charts
        const labels  = feeds.map(f => new Date(f.created_at));
        const cpmData = feeds.map(f => parseFloat(f.field1) || null);
        const usvData = feeds.map(f => parseFloat(f.field2) || null);

        // Period average / min / max stat cards
        const validUSV = usvData.filter(v => v !== null && !isNaN(v));
        const avgUSV   = validUSV.length > 0 ? validUSV.reduce((a, b) => a + b, 0) / validUSV.length : null;
        const minUSV   = validUSV.length > 0 ? Math.min(...validUSV) : null;
        const maxUSV   = validUSV.length > 0 ? Math.max(...validUSV) : null;
        document.getElementById('avgUSVLabel').textContent = getAvgLabel();
        document.getElementById('avgUSV').textContent  = avgUSV !== null ? avgUSV.toFixed(4) : '--';
        document.getElementById('minMaxLabel').textContent = getAvgLabel().replace('Avg', 'Range');
        document.getElementById('periodLow').textContent  = minUSV !== null ? minUSV.toFixed(4) : '--';
        document.getElementById('periodHigh').textContent = maxUSV !== null ? maxUSV.toFixed(4) : '--';
        document.getElementById('periodHigh').style.color = scaleColor(maxUSV);

        // Moving average datasets for trend lines
        const win     = getAvgWindow();
        const cpmAvg  = computeMovingAverage(cpmData, win);
        const usvAvg  = computeMovingAverage(usvData, win);

        buildChart('cpmChart', labels, cpmData, cpmAvg, 'CPM',   '#FFD700', 'rgba(255,215,0,0.08)');
        buildChart('usvChart', labels, usvData, usvAvg, '¬µSv/h', '#FFA500', 'rgba(255,165,0,0.08)', 6, 0.30);

        // Last update
        const ago = timeAgo(new Date(latest.created_at));
        document.getElementById('lastUpdate').textContent = `Last reading: ${ago}`;
    }

    function updateStatus(usv) {
        const card = document.getElementById('statusCard');
        const icon = document.getElementById('statusIcon');
        const val  = document.getElementById('currentStatus');
        const desc = document.getElementById('statusDesc');

        card.className = 'stat-card';

        if (usv < 0.3) {
            card.classList.add('status-normal');
            icon.textContent = 'üü¢';
            val.textContent  = 'Normal';
            desc.textContent = 'Natural background';
        } else if (usv < 1.0) {
            card.classList.add('status-elevated');
            icon.textContent = 'üü°';
            val.textContent  = 'Slight';
            desc.textContent = 'Slightly elevated';
        } else if (usv < 5.0) {
            card.classList.add('status-elevated');
            icon.textContent = 'üü†';
            val.textContent  = 'Elevated';
            desc.textContent = 'Above normal';
        } else if (usv < 20.0) {
            card.classList.add('status-high');
            icon.textContent = 'üî¥';
            val.textContent  = 'High';
            desc.textContent = 'Significant dose rate';
        } else {
            card.classList.add('status-danger');
            icon.textContent = '‚ò¢';
            val.textContent  = 'DANGER';
            desc.textContent = 'Evacuate area!';
        }
    }

    function updateScaleMarker(usv) {
        // Log scale: map ¬µSv/h to 0‚Äì100% position
        // Scale: 0.05 ‚Üí 0%, 0.3 ‚Üí 20%, 1.0 ‚Üí 40%, 5.0 ‚Üí 60%, 20 ‚Üí 80%, 100+ ‚Üí 100%
        const breakpoints = [0.05, 0.3, 1.0, 5.0, 20.0, 100.0];
        const positions   = [0,    20,   40,  60,  80,   100];

        let pct = 0;
        if (usv <= breakpoints[0]) {
            pct = 0;
        } else if (usv >= breakpoints[breakpoints.length-1]) {
            pct = 100;
        } else {
            for (let i = 0; i < breakpoints.length - 1; i++) {
                if (usv >= breakpoints[i] && usv < breakpoints[i+1]) {
                    const t = (usv - breakpoints[i]) / (breakpoints[i+1] - breakpoints[i]);
                    pct = positions[i] + t * (positions[i+1] - positions[i]);
                    break;
                }
            }
        }
        document.getElementById('scaleMarker').style.left = Math.min(98, Math.max(1, pct)) + '%';
    }

    function buildChart(id, labels, data, avgData, label, lineColor, fillColor, decimals = 1, thresholdVal = null) {
        if (charts[id]) { charts[id].destroy(); }
        const ctx = document.getElementById(id).getContext('2d');

        const datasets = [
            {
                label,
                data,
                borderColor: lineColor,
                backgroundColor: fillColor,
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointRadius: data.length > 200 ? 0 : 2,
                pointHoverRadius: 5,
                spanGaps: true,
                order: 2
            },
            {
                label: getAvgLabel(),
                data: avgData,
                borderColor: 'rgba(255,255,255,0.55)',
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                borderDash: [6, 4],
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                pointHoverRadius: 4,
                spanGaps: true,
                order: 1
            }
        ];

        if (thresholdVal !== null) {
            datasets.push({
                label: `Normal limit (${thresholdVal} ¬µSv/h)`,
                data: labels.map(() => thresholdVal),
                borderColor: 'rgba(76,175,80,0.7)',
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                borderDash: [4, 4],
                fill: false,
                pointRadius: 0,
                pointHoverRadius: 0,
                spanGaps: true,
                order: 3
            });
        }

        charts[id] = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#888',
                            boxWidth: 16,
                            font: { size: 11 },
                            usePointStyle: true,
                            pointStyle: 'line'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        borderColor: 'rgba(255,215,0,0.3)',
                        borderWidth: 1,
                        titleColor: '#FFD700',
                        bodyColor: '#ccc',
                        padding: 12,
                        callbacks: {
                            title: ctx => new Date(ctx[0].label).toLocaleString(),
                            label: ctx => {
                                if (thresholdVal !== null && ctx.datasetIndex === 2) return null;
                                const v = ctx.parsed.y;
                                const suffix = ctx.datasetIndex === 0 ? label : getAvgLabel();
                                return ` ${v !== null && !isNaN(v) ? v.toFixed(decimals) : 'N/A'} ${suffix}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { tooltipFormat: 'dd MMM HH:mm', displayFormats: getXFormats() },
                        ticks: {
                            color: '#666',
                            maxTicksLimit: 8,
                            autoSkip: true,
                            maxRotation: 0
                        },
                        grid: { color: 'rgba(255,255,255,0.04)' }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#666',
                            callback: v => v.toFixed(decimals)
                        },
                        grid: { color: 'rgba(255,255,255,0.06)' }
                    }
                }
            }
        });
    }

    function scaleColor(usv) {
        if (usv === null) return '#888';
        if (usv < 0.3)  return '#4CAF50';  // green  ‚Äî normal
        if (usv < 1.0)  return '#FFD700';  // yellow ‚Äî slightly elevated
        if (usv < 5.0)  return '#FF8C00';  // orange ‚Äî elevated
        if (usv < 20.0) return '#FF4444';  // red    ‚Äî high
        return '#880000';                  // dark red ‚Äî danger
    }

    function getAvgLabel() {
        const labels = { '1h': '1hr Avg', '24h': '24hr Avg', '7d': '7 Day Avg', '30d': '30 Day Avg' };
        return labels[currentRange] || 'Average';
    }

    function getAvgWindow() {
        // Window size tuned so the smoothing makes visual sense for each range's data density
        const windows = { '1h': 10, '24h': 60, '7d': 6, '30d': 5 };
        return windows[currentRange] || 10;
    }

    function computeMovingAverage(data, window) {
        const half = Math.floor(window / 2);
        return data.map((_, i) => {
            const start = Math.max(0, i - half);
            const end   = Math.min(data.length, i + half + 1);
            const slice = data.slice(start, end).filter(v => v !== null && !isNaN(v));
            return slice.length > 0 ? slice.reduce((a, b) => a + b, 0) / slice.length : null;
        });
    }

    function getXFormats() {
        switch (currentRange) {
            case '1h':  return { minute: 'HH:mm', hour: 'HH:mm' };
            case '24h': return { hour: 'HH:mm', day: 'dd MMM' };
            case '7d':  return { day: 'dd MMM', hour: 'dd MMM HH:mm' };
            case '30d': return { day: 'dd MMM', week: 'dd MMM' };
            default:    return { day: 'dd MMM' };
        }
    }

    function timeAgo(date) {
        const diff = Math.floor((Date.now() - date) / 60000);
        if (diff < 1)   return 'Just now';
        if (diff < 60)  return `${diff} minute${diff > 1 ? 's' : ''} ago`;
        const h = Math.floor(diff / 60);
        if (h < 24)     return `${h} hour${h > 1 ? 's' : ''} ago`;
        const d = Math.floor(h / 24);
        return `${d} day${d > 1 ? 's' : ''} ago`;
    }
</script>
</body>
</html>
